<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TDF Analyzer Web</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    background-color: #f8f9fa;
  }
  .lang-toggle img {
    cursor: pointer;
    width: 30px;
    opacity: 0.7;
    transition: opacity 0.2s;
  }
  .lang-toggle img:hover, .lang-toggle img.active {
    opacity: 1;
  }
  .archetype-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 8px;
    list-style: none;
    padding: 0;
  }
  .archetype-list li {
    position: relative;
    height: 90px;
    border-radius: 0.375rem;
    cursor: pointer;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    overflow: hidden;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    border: 1px solid #dee2e6;
  }
  .archetype-list li.selected {
    outline: 3px solid #0d6efd;
  }
  .archetype-list li .arch-name {
    width: 100%;
    text-align: center;
    font-weight: bold;
    color: #fff;
    padding: 6px 0;
    background: rgba(0,0,0,0.55);
  }
  .scroll {
    max-height: 500px;
    overflow: auto;
  }
  #playersContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 16px;
  }
  .player {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
  }
  .pill {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: .75em;
    font-weight: 700;
    line-height: 1;
    color: #212529;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
    background-color: #e9ecef;
  }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#" data-lang-key="title">TDF Analyzer Web</a>
    <span class="navbar-text" data-lang-key="subtitle">
      100% client-side. Your data never leaves your browser.
    </span>
    <div class="d-flex ms-auto lang-toggle">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMTIzNSIgaGVpZ2h0PSI2NTAiIHZpZXdCb3g9IjAgMCA3NDEwIDM5MDAiPjxwYXRoIGQ9Ik0wLDBoNzQxMHYzOTAwSDAiIGZpbGw9IiNiMzE5NDIiLz48cGF0aCBkPSJNMCw0NTBINzQxMG0wLDYwMEgwbTAsNjAwSDc0MTBtMCw2MDBIMG0wLDYwMEg3NDEwbTAsNjAwSDAiIHN0cm9rZT0iI0ZGRiIgc3Ryb2tlLXdpZHRoPSIzMDAiLz48cGF0aCBkPSJNMCwwaDI5NjR2MjEwMEgwIiBmaWxsPSIjMGEzMTYxIi8+PGcgZmlsbD0iI0ZGRiI+PGcgaWQ9InMxOCI+PGcgaWQ9InM5Ij48ZyBpZD0iczUiPjxnIGlkPSJzNCI+PHBhdGggaWQ9InMiIGQ9Ik0yNDcsOTAgMzE3LjUzNDIzMCwzMDcuMDgyMDM5IDEzMi44NzMyMTgsMTcyLjkxNzk2MUgzNjEuMTI2NzgyTDE3Ni40NjU3NzAsMzA3LjA4MjAzOXoiLz48dXNlIHhsaW5rOmhyZWY9IiNzIiB5PSI0MjAiLz48dXNlIHhsaW5rOmhyZWY9IiNzIiB5PSI4NDAiLz48dXNlIHhsaW5rOmhyZWY9IiNzIiB5PSIxMjYwIi8+PC9nPjx1c2UgeGxpbms6aHJlZj0iI3MiIHk9IjE2ODAiLz48L2c+PHVzZSB4bGluazpocmVmPSIjczQiIHg9IjI0NyIgeT0iMjEwIi8+PC9nPjx1c2UgeGxpbms6aHJlZj0iI3M5IiB4PSI0OTQiLz48L2c+PHVzZSB4bGluazpocmVmPSIjczE4IiB4PSI5ODgiLz48dXNlIHhsaW5rOmhyZWY9IiNzOSIgeD0iMTk3NiIvPjx1c2UgeGxpbms6aHJlZj0iI3M1IiB4PSIyNDcwIi8+PC9nPjwvc3ZnPg==" alt="EN" id="lang-en" class="active me-2">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzIDIiIHdpZHRoPSIzMCIgaGVpZ2h0PSIyMCI+CiAgPHJlY3Qgd2lkdGg9IjMiIGhlaWdodD0iMiIgZmlsbD0iI2M2MGExZCIvPgogIDxyZWN0IHdpZHRoPSIzIiBoZWlnaHQ9IjEiIHk9IjAuNSIgZmlsbD0iI2ZmYzQwMCIvPgo8L3N2Zz4=" alt="ES" id="lang-es">
    </div>
  </div>
</nav>

<main class="container mt-4">
  <div class="row g-4">
    
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2 data-lang-key="load_files_header">1. Load TDF/XML Files</h2>
        </div>
        <div class="card-body">
          <div class="row align-items-center g-3">
            <div class="col-md-5">
              <input type="file" id="xmlFiles" class="form-control" accept=".xml,.tdf" multiple>
            </div>
            <div class="col-md-5">
              <select id="tournamentSelect" class="form-select" data-lang-title="tournament_select_title"></select>
            </div>
            <div class="col-md-2">
              <span id="tdfSummary" class="form-text"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2 data-lang-key="edit_archetypes_header">2. Edit Archetypes</h2>
        </div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
            <input type="text" id="archetypeName" class="form-control" style="width: 200px;" data-lang-placeholder="archetype_name_placeholder">
            <input type="file" id="archetypeImage" class="form-control" style="width: 250px;" accept="image/*">
            <button id="addArchetype" class="btn btn-primary" data-lang-key="add_button">Add</button>
            <button id="removeArchetype" class="btn btn-danger" data-lang-key="remove_button">Remove</button>
            <div class="btn-group">
                <button id="saveArchetypes" class="btn btn-secondary" data-lang-key="download_json_button">Download JSON</button>
                <button id="loadArchetypes" class="btn btn-secondary" data-lang-key="import_json_button">Import JSON</button>
            </div>
            <div class="form-check form-switch ms-auto">
              <input class="form-check-input" type="checkbox" role="switch" id="persistArchetypes">
              <label class="form-check-label" for="persistArchetypes" data-lang-key="save_in_browser_label">Save in this browser</label>
            </div>
          </div>
          <ul id="archetypeList" class="archetype-list"></ul>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2 data-lang-key="assign_archetypes_header">3. Assign Archetypes to Players</h2>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2 mb-3">
                <button id="saveAssignments" class="btn btn-secondary" data-lang-key="download_assignments_button">Download Assignments</button>
                <button id="loadAssignments" class="btn btn-secondary" data-lang-key="import_assignments_button">Import Assignments</button>
                <div class="form-check form-switch ms-auto">
                    <input class="form-check-input" type="checkbox" role="switch" id="persistAssignments">
                    <label class="form-check-label" for="persistAssignments" data-lang-key="save_in_browser_label">Save in this browser</label>
                </div>
            </div>
          <div id="playersContainer"></div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2 data-lang-key="filters_header">4. Filters</h2>
        </div>
        <div class="card-body">
          <div class="row align-items-center g-3">
            <div class="col-md-3">
              <label for="divisionFilter" class="form-label" data-lang-key="division_label">Division:</label>
              <select id="divisionFilter" class="form-select">
                <option value="ALL" data-lang-key="all_option">All</option>
                <option value="MR">MR</option>
                <option value="SR">SR</option>
                <option value="JR">JR</option>
              </select>
            </div>
            <div class="col-md-9">
              <button id="generateMatrix" class="btn btn-success mt-4" data-lang-key="generate_matrix_button">Generate Matrix</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2 data-lang-key="winrate_matrix_header">5. Winrate Matrix</h2>
            </div>
            <div class="card-body">
                <div class="scroll table-responsive">
                    <table id="matrixTable" class="table table-bordered table-sm text-center"></table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h2 data-lang-key="match_examples_header">6. Match Examples</h2>
            </div>
            <div class="card-body">
                <div class="scroll table-responsive">
                    <table id="examplesTable" class="table table-striped table-sm"></table>
                </div>
            </div>
        </div>
    </div>

  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ====== LANGUAGE & TRANSLATION ======
const translations = {
    en: {
        title: "TDF Analyzer Web",
        subtitle: "100% client-side. Your data never leaves your browser.",
        load_files_header: "1. Load TDF/XML Files",
        tournament_select_title: "Tournament",
        edit_archetypes_header: "2. Edit Archetypes",
        archetype_name_placeholder: "Archetype name",
        add_button: "Add",
        remove_button: "Remove",
        download_json_button: "Download JSON",
        import_json_button: "Import JSON",
        save_in_browser_label: "Save in this browser",
        assign_archetypes_header: "3. Assign Archetypes to Players",
        download_assignments_button: "Download Assignments",
        import_assignments_button: "Import Assignments",
        filters_header: "4. Filters",
        division_label: "Division:",
        all_option: "All",
        generate_matrix_button: "Generate Matrix",
        winrate_matrix_header: "5. Winrate Matrix",
        match_examples_header: "6. Match Examples",
        unassigned_option: "(unassigned)",
        no_data_message: "Not enough data (assign archetypes and apply filters).",
        select_tournament_placeholder: "Select a tournament",
        loaded_tournaments_summary: "Loaded {count} tournaments.",
        invalid_json_alert: "Invalid JSON",
        duplicate_archetype_alert: "Archetype name cannot be empty or duplicated.",
        select_tournament_matrix_placeholder: "Select a tournament to see the matrix.",
        no_examples_message: "No examples for this filter combination.",
        example_matches_caption: "Example Matches: {a1} vs {a2}",
        mirrors_title: "{count} mirrors",
        win_loss_tie_title: "{wins} wins, {losses} losses, {ties} ties",
        p1_win_result: "P1 Win",
        p2_win_result: "P2 Win",
        tie_result: "Tie",
        player_1_header: "Player 1",
        archetype_1_header: "Archetype 1",
        player_2_header: "Player 2",
        archetype_2_header: "Archetype 2",
        result_header: "Result",
        round_header: "Round",
    },
    es: {
        title: "TDF Analyzer Web",
        subtitle: "100% client-side. Tus datos no salen del navegador.",
        load_files_header: "1. Cargar archivos TDF/XML",
        tournament_select_title: "Torneo",
        edit_archetypes_header: "2. Editar arquetipos",
        archetype_name_placeholder: "Nombre de arquetipo",
        add_button: "Añadir",
        remove_button: "Eliminar",
        download_json_button: "Descargar JSON",
        import_json_button: "Importar JSON",
        save_in_browser_label: "Guardar en este navegador",
        assign_archetypes_header: "3. Asignar arquetipos a jugadores",
        download_assignments_button: "Descargar asignaciones",
        import_assignments_button: "Importar asignaciones",
        filters_header: "4. Filtros",
        division_label: "División:",
        all_option: "Todas",
        generate_matrix_button: "Generar matriz",
        winrate_matrix_header: "5. Matriz de winrates",
        match_examples_header: "6. Ejemplos de partidas",
        unassigned_option: "(sin asignar)",
        no_data_message: "No hay datos suficientes (asigna arquetipos y aplica filtros).",
        select_tournament_placeholder: "Seleccione un torneo",
        loaded_tournaments_summary: "Cargados {count} torneos.",
        invalid_json_alert: "JSON inválido",
        duplicate_archetype_alert: "El nombre del arquetipo no puede estar vacío o duplicado.",
        select_tournament_matrix_placeholder: "Selecciona un torneo para ver la matriz.",
        no_examples_message: "No hay ejemplos para esta combinación de filtros.",
        example_matches_caption: "Partidas de ejemplo: {a1} vs {a2}",
        mirrors_title: "{count} mirrors",
        win_loss_tie_title: "{wins} victorias, {losses} derrotas, {ties} empates",
        p1_win_result: "Gana J1",
        p2_win_result: "Gana J2",
        tie_result: "Empate",
        player_1_header: "Jugador 1",
        archetype_1_header: "Arquetipo 1",
        player_2_header: "Jugador 2",
        archetype_2_header: "Arquetipo 2",
        result_header: "Resultado",
        round_header: "Ronda",
    }
};
let currentLang = 'en';

function setLanguage(lang) {
    if (!translations[lang]) return;
    currentLang = lang;
    localStorage.setItem('preferred_language', lang);
    document.documentElement.lang = lang;
    
    document.querySelectorAll('[data-lang-key]').forEach(el => {
        const key = el.getAttribute('data-lang-key');
        if (translations[lang][key]) {
            el.textContent = translations[lang][key];
        }
    });
    document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
        const key = el.getAttribute('data-lang-placeholder');
        if (translations[lang][key]) {
            el.placeholder = translations[lang][key];
        }
    });
    document.querySelectorAll('[data-lang-title]').forEach(el => {
        const key = el.getAttribute('data-lang-title');
        if (translations[lang][key]) {
            el.title = translations[lang][key];
        }
    });

    document.getElementById('lang-en').classList.toggle('active', lang === 'en');
    document.getElementById('lang-es').classList.toggle('active', lang === 'es');

    tournamentSelect.innerHTML = `<option value="">${getTranslation("select_tournament_placeholder")}</option>`;
    tdfDataList.forEach((tdf, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `${i+1}. ${tdf.name || getTranslation('tournament_select_title')}`;
        tournamentSelect.appendChild(opt);
    });
    if(tdfDataList.length > 0) {
        tournamentSelect.value = "0";
        tdfSummary.textContent = getTranslation('loaded_tournaments_summary', {count: tdfDataList.length});
    }

    renderPlayers();
    renderMatrix();
    renderExamples("",""); 
}

function getTranslation(key, replacements = {}) {
    let text = translations[currentLang][key] || translations['en'][key] || key;
    for (const placeholder in replacements) {
        text = text.replace(`{${placeholder}}`, replacements[placeholder]);
    }
    return text;
}

document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
document.getElementById('lang-es').addEventListener('click', () => setLanguage('es'));


// ====== REFERENCIAS DOM ======
const xmlInput = document.getElementById("xmlFiles");
const tdfSummary = document.getElementById("tdfSummary");
const tournamentSelect = document.getElementById("tournamentSelect");
const listEl = document.getElementById("archetypeList");
const nameEl = document.getElementById("archetypeName");
const imgEl  = document.getElementById("archetypeImage");
const persistArchEl = document.getElementById("persistArchetypes");
const playersContainer = document.getElementById("playersContainer");
const persistAssignEl  = document.getElementById("persistAssignments");
const matrixTable = document.getElementById("matrixTable");
const divisionFilter = document.getElementById("divisionFilter");
const examplesTable = document.getElementById("examplesTable");

// ===== Utilidades y modelos =====
function getDivisionFromLastname(lastname) {
  if (lastname === "MR") return "MR";
  if (lastname === "SR") return "SR";
  if (lastname === "JR") return "JR";
  return "Unknown";
}
function lowestDivision(div1, div2) {
  const order = { MR:3, SR:2, JR:1 };
  return (order[div1] || 0) < (order[div2] || 0) ? div1 : div2;
}
function getWinrateColor(winrate) {
  if (winrate == null) return "#f8f9fa";
  if (winrate < 0.45) return "#f8d7da";
  if (winrate < 0.5) return "#fff3cd";
  if (winrate < 0.55) return "#cfe2ff";
  return "#d1e7dd";
}

class Player {
  constructor(userid, name, division) {
    this.userid = userid;
    this.name = name;
    this.division = division;
    this.archetype = null;
  }
}
class Match {
  constructor(p1, p2, outcome, roundNum, podCat) {
    this.p1 = p1; this.p2 = p2;
    this.outcome = outcome;
    this.roundNum = roundNum;
    this.podCat = podCat;
  }
}
class TDFData {
  constructor(fileContent, name="") {
    this.fileContent = fileContent;
    this.name = name;
    this.players = {};
    this.matches = [];
  }
  parseFile() {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(this.fileContent, "application/xml");
    const playersNode = xmlDoc.querySelector("players");
    if (playersNode) {
      playersNode.querySelectorAll(":scope > player").forEach(p => {
        const userid = p.getAttribute("userid");
        const firstname = p.querySelector("firstname")?.textContent || "";
        const lastname = p.querySelector("lastname")?.textContent || "";
        const division = getDivisionFromLastname(lastname);
        this.players[userid] = new Player(userid, `${firstname} ${lastname}`, division);
      });
    }
    const podsNode = xmlDoc.querySelector("pods");
    if (podsNode) {
      podsNode.querySelectorAll(":scope > pod").forEach(pod => {
        const podCat = pod.getAttribute("category") || "";
        pod.querySelectorAll(":scope > rounds").forEach(rounds => {
          rounds.querySelectorAll(":scope > round").forEach(round => {
            const roundNum = round.getAttribute("number") || "";
            round.querySelectorAll(":scope > matches > match").forEach(match => {
              const p1 = match.querySelector(":scope > player1")?.getAttribute("userid");
              const p2 = match.querySelector(":scope > player2")?.getAttribute("userid");
              if (!p1 || !p2) return;
              const outcome = match.getAttribute("outcome") || "";
              this.matches.push(new Match(p1, p2, outcome, roundNum, podCat));
            });
          });
        });
      });
    }
  }
}

// ===== Estado global =====
let tdfDataList = [];
let archetypes = [];
let selectedArchIndex = null;
let playerArchetypeMap = {};

// ===== Helpers persistencia =====
function saveLocal(key, value, enabled) {
  if (!enabled) return;
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {
    console.error("Error saving to local storage", e);
  }
}
function loadLocal(key) {
  const raw = localStorage.getItem(key);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

// ===== Carga de archivos =====
xmlInput.addEventListener("change", (evt) => {
  const files = Array.from(evt.target.files);
  tdfDataList = [];
  tournamentSelect.innerHTML = `<option value="">${getTranslation("select_tournament_placeholder")}</option>`;
  playerArchetypeMap = {};
  if (files.length === 0) {
    tdfSummary.textContent = "";
    renderPlayers();
    renderMatrix();
    renderExamples("","");
    return;
  }
  let pending = files.length;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const tdf = new TDFData(e.target.result, file.name);
      tdf.parseFile();
      tdfDataList.push(tdf);
      if (--pending === 0) {
        tdfDataList.forEach((tdf, i) => {
          const opt = document.createElement("option");
          opt.value = String(i);
          opt.textContent = `${i+1}. ${tdf.name || getTranslation('tournament_select_title')}`;
          tournamentSelect.appendChild(opt);
        });
        tdfSummary.textContent = getTranslation('loaded_tournaments_summary', {count: tdfDataList.length});
        if(tdfDataList.length > 0) tournamentSelect.value = "0";
        renderPlayers();
        renderMatrix(); 
      }
    };
    reader.readAsText(file);
  });
});

// ===== Arquetipos (CRUD) =====
(function bootstrapArchetypes() {
  persistArchEl.checked = !!loadLocal("tdf_persist_arch");
  persistArchEl.addEventListener("change", () => saveLocal("tdf_persist_arch", persistArchEl.checked, true));
  
  const saved = persistArchEl.checked ? loadLocal("tdf_archetypes") : null;
  if (saved && saved.length > 0) {
    archetypes = saved;
    refreshArchetypeList();
  } else {
    fetch('archetypes.json')
      .then(res => res.ok ? res.json() : Promise.reject())
      .then(data => {
        archetypes = (Array.isArray(data) && typeof data[0] === "string")
          ? data.map(n => ({name:n, image:null}))
          : data;
        refreshArchetypeList();
      })
      .catch(() => { /* No-op */ });
  }
})();

function refreshArchetypeList() {
  listEl.innerHTML = "";
  archetypes.sort((a, b) => a.name.localeCompare(b.name));
  archetypes.forEach((arch, idx) => {
    const li = document.createElement("li");
    li.dataset.index = String(idx);
    if (Number(idx) === selectedArchIndex) li.classList.add("selected");
    
    let imagePath = arch.image;
    if (imagePath && !imagePath.startsWith('data:image')) {
        const imageName = imagePath.split(/[\\/]/).pop();
        imagePath = `archetype_images/${imageName}`;
    }
    
    li.style.backgroundImage = imagePath ? `url('${imagePath.replace(/\\/g, "/")}')` : 'none';
    li.style.backgroundColor = imagePath ? '#6c757d' : '#e9ecef';

    const nameSpan = document.createElement("span");
    nameSpan.className = "arch-name";
    nameSpan.textContent = arch.name;
    li.appendChild(nameSpan);

    li.addEventListener("click", () => {
      selectedArchIndex = (selectedArchIndex === idx) ? null : idx;
      refreshArchetypeList();
    });
    listEl.appendChild(li);
  });
  renderPlayers();
}

document.getElementById("addArchetype").addEventListener("click", () => {
  const name = nameEl.value.trim();
  if (!name || archetypes.some(a => a.name === name)) {
    alert(getTranslation("duplicate_archetype_alert"));
    return;
  }
  if (imgEl.files.length > 0) {
    const reader = new FileReader();
    reader.onload = e => {
      archetypes.push({ name, image: e.target.result });
      nameEl.value = ""; imgEl.value = "";
      saveLocal("tdf_archetypes", archetypes, persistArchEl.checked);
      refreshArchetypeList();
    };
    reader.readAsDataURL(imgEl.files[0]);
  } else {
    archetypes.push({ name, image: null });
    nameEl.value = ""; imgEl.value = "";
    saveLocal("tdf_archetypes", archetypes, persistArchEl.checked);
    refreshArchetypeList();
  }
});

document.getElementById("removeArchetype").addEventListener("click", () => {
  if (selectedArchIndex == null) return;
  const removed = archetypes.splice(selectedArchIndex, 1)[0];
  Object.keys(playerArchetypeMap).forEach(uid => {
    if (playerArchetypeMap[uid] === removed.name) delete playerArchetypeMap[uid];
  });
  selectedArchIndex = null;
  saveLocal("tdf_archetypes", archetypes, persistArchEl.checked);
  saveLocal("tdf_assignments", playerArchetypeMap, persistAssignEl.checked);
  refreshArchetypeList();
});

document.getElementById("saveArchetypes").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(archetypes, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement("a"), { href:url, download:"archetypes.json" });
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

document.getElementById("loadArchetypes").addEventListener("click", () => {
  const input = Object.assign(document.createElement("input"), { type: "file", accept: ".json" });
  input.onchange = () => {
    const file = input.files[0]; if (!file) return;
    const r = new FileReader();
    r.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        archetypes = (Array.isArray(data) && typeof data[0] === "string")
          ? data.map(n => ({name:n, image:null}))
          : data;
        saveLocal("tdf_archetypes", archetypes, persistArchEl.checked);
        refreshArchetypeList();
      } catch { alert(getTranslation("invalid_json_alert")); }
    };
    r.readAsText(file);
  };
  input.click();
});

// ===== Asignación de arquetipos a jugadores =====
(function bootstrapAssignments() {
  persistAssignEl.checked = !!loadLocal("tdf_persist_assign");
  persistAssignEl.addEventListener("change", () => saveLocal("tdf_persist_assign", persistAssignEl.checked, true));

  const saved = persistAssignEl.checked ? loadLocal("tdf_assignments") : null;
  if (saved) playerArchetypeMap = saved;
})();

function allPlayersCurrentTournament() {
  const idx = Number(tournamentSelect.value);
  if (isNaN(idx) || idx < 0 || idx >= tdfDataList.length) return {};
  const tdf = tdfDataList[idx];
  return tdf ? tdf.players : {};
}

function renderPlayers() {
  playersContainer.innerHTML = "";
  const players = allPlayersCurrentTournament();
  const archNames = archetypes.map(a => a.name);
  const sortedPlayers = Object.values(players).sort((a,b) => a.name.localeCompare(b.name));

  sortedPlayers.forEach(p => {
    const row = document.createElement("div");
    row.className = "player";
    
    const info = document.createElement("div");
    info.innerHTML = `<strong>${p.name}</strong> <span class="pill">${p.division}</span> <small class="text-muted ms-2">ID: ${p.userid}</small>`;
    
    const select = document.createElement("select");
    select.className = "form-select form-select-sm";
    select.style.width = "180px";
    select.dataset.userid = p.userid;
    select.innerHTML = `<option value="">${getTranslation("unassigned_option")}</option>`;
    
    archNames.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name; opt.textContent = name;
      select.appendChild(opt);
    });

    if (playerArchetypeMap[p.userid]) select.value = playerArchetypeMap[p.userid];
    
    select.addEventListener("change", () => {
      if (select.value) playerArchetypeMap[p.userid] = select.value;
      else delete playerArchetypeMap[p.userid];
      saveLocal("tdf_assignments", playerArchetypeMap, persistAssignEl.checked);
    });
    
    row.appendChild(info);
    row.appendChild(select);
    playersContainer.appendChild(row);
  });
}

document.getElementById("saveAssignments").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(playerArchetypeMap, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement("a"), { href:url, download:"player_archetypes.json" });
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

document.getElementById("loadAssignments").addEventListener("click", () => {
  const input = Object.assign(document.createElement("input"), { type: "file", accept: ".json" });
  input.onchange = () => {
    const file = input.files[0]; if (!file) return;
    const r = new FileReader();
    r.onload = e => {
      try {
        playerArchetypeMap = JSON.parse(e.target.result);
        saveLocal("tdf_assignments", playerArchetypeMap, persistAssignEl.checked);
        renderPlayers();
      } catch { alert(getTranslation("invalid_json_alert")); }
    };
    r.readAsText(file);
  };
  input.click();
});

tournamentSelect.addEventListener("change", () => {
  renderPlayers();
  renderMatrix();
  renderExamples("","");
});

// ===== Matriz de winrates =====
document.getElementById("generateMatrix").addEventListener("click", renderMatrix);
divisionFilter.addEventListener("change", renderMatrix);


function computeMatrixData(tdf) {
  const stats = new Map();
  const withMatches = new Set();

  function keyFor(a, b) { return a <= b ? `${a}|||${b}` : `${b}|||${a}`; }
  function getEntry(a,b) {
    const k = keyFor(a,b);
    if (!stats.has(k)) {
      stats.set(k, { a: k.split("|||")[0], b: k.split("|||")[1],
        winsA:0, winsB:0, ties:0, mirrors:0 });
    }
    return stats.get(k);
  }

  const divFilter = divisionFilter.value;
  Object.entries(tdf.players).forEach(([uid, p]) => {
    p.archetype = playerArchetypeMap[uid] || null;
  });

  tdf.matches.forEach(m => {
    const p1 = tdf.players[m.p1], p2 = tdf.players[m.p2];
    if (!p1 || !p2 || !p1.archetype || !p2.archetype) return;

    const matchDiv = lowestDivision(p1.division, p2.division);
    if (divFilter !== "ALL" && matchDiv !== divFilter) return;

    withMatches.add(p1.archetype); withMatches.add(p2.archetype);

    if (p1.archetype === p2.archetype) {
      const e = getEntry(p1.archetype, p2.archetype);
      e.mirrors++;
    } else {
      const e = getEntry(p1.archetype, p2.archetype);
      if (m.outcome === "1") e.a === p1.archetype ? e.winsA++ : e.winsB++;
      else if (m.outcome === "2") e.b === p1.archetype ? e.winsA++ : e.winsB++;
      else if (m.outcome === "3") e.ties++;
    }
  });
  
  const archs = Array.from(withMatches).sort();
  return { stats, archs };
}

function renderMatrix() {
  matrixTable.innerHTML = "";
  const idx = Number(tournamentSelect.value);
  if (isNaN(idx) || idx < 0 || idx >= tdfDataList.length) {
      matrixTable.innerHTML = `<thead><tr><th class='text-muted fw-normal'>${getTranslation("select_tournament_matrix_placeholder")}</th></tr></thead>`;
      return;
  }
  const tdf = tdfDataList[idx];

  const { stats, archs } = computeMatrixData(tdf);
  if (archs.length === 0) {
    matrixTable.innerHTML = `<thead><tr><th class='text-muted fw-normal'>${getTranslation("no_data_message")}</th></tr></thead>`;
    renderExamples("","");
    return;
  }

  const thead = matrixTable.createTHead();
  const hrow = thead.insertRow();
  hrow.insertCell().outerHTML = "<th></th>";
  archs.forEach(a => hrow.insertCell().outerHTML = `<th class="text-truncate" style="max-width: 150px;">${a}</th>`);

  const tbody = matrixTable.createTBody();

  function getEntry(a,b) {
    const k = a <= b ? `${a}|||${b}` : `${b}|||${a}`;
    return stats.get(k);
  }

  archs.forEach(a1 => {
    const row = tbody.insertRow();
    row.insertCell().outerHTML = `<th class="text-truncate" style="max-width: 150px;">${a1}</th>`;

    archs.forEach(a2 => {
      const td = row.insertCell();
      td.style.cursor = "pointer";
      td.dataset.arch1 = a1;
      td.dataset.arch2 = a2;

      if (a1 === a2) {
        const e = getEntry(a1, a2);
        td.textContent = e ? `${e.mirrors}m` : '0m';
        td.style.backgroundColor = "#e9ecef";
        td.title = getTranslation('mirrors_title', {count: e ? e.mirrors : 0});
      } else {
        const e = getEntry(a1, a2);
        if (!e) { 
          td.textContent = "0-0-0";
          td.style.backgroundColor = "#f8f9fa";
          td.title = getTranslation('win_loss_tie_title', {wins:0, losses:0, ties:0});
        } else {
            const wins = e.a === a1 ? e.winsA : e.winsB;
            const losses = e.a === a1 ? e.winsB : e.winsA;
            const ties = e.ties;
            const total = wins + losses;
            const winrate = total > 0 ? (wins / total) : null;
            
            td.innerHTML = `<div class="fw-bold">${(winrate != null ? (winrate * 100).toFixed(0) : "–")}%</div>
                            <small class="text-muted">${wins}-${losses}-${ties}</small>`;
            td.style.backgroundColor = getWinrateColor(winrate);
            td.title = getTranslation('win_loss_tie_title', {wins, losses, ties});
        }
      }

      td.addEventListener("click", () => showExamplesForCell(a1, a2));
    });
  });
}

// ===== Ejemplos =====
function showExamplesForCell(a1, a2) {
  const idx = Number(tournamentSelect.value);
  if (isNaN(idx) || idx < 0 || idx >= tdfDataList.length) return;
  const tdf = tdfDataList[idx];

  Object.entries(tdf.players).forEach(([uid, p]) => {
    p.archetype = playerArchetypeMap[uid] || null;
  });
  const divFilter = divisionFilter.value;

  const rows = [];
  tdf.matches.forEach(m => {
    const p1 = tdf.players[m.p1], p2 = tdf.players[m.p2];
    if (!p1 || !p2 || !p1.archetype || !p2.archetype) return;
    const matchDiv = lowestDivision(p1.division, p2.division);
    if (divFilter !== "ALL" && matchDiv !== divFilter) return;

    if (a1 === a2) {
        if (p1.archetype === a1 && p2.archetype === a2) {
            let result = getTranslation('tie_result');
            if (m.outcome === "1") result = getTranslation('p1_win_result');
            if (m.outcome === "2") result = getTranslation('p2_win_result');
            rows.push([p1.name, p1.archetype, p2.name, p2.archetype, result, m.roundNum]);
        }
    } else {
        const p1isA1 = p1.archetype === a1, p2isA2 = p2.archetype === a2;
        const p1isA2 = p1.archetype === a2, p2isA1 = p2.archetype === a1;

        if ((p1isA1 && p2isA2) || (p1isA2 && p2isA1)) {
            let outcomeText = getTranslation('tie_result');
            if (m.outcome === "1") outcomeText = `${p1.name} Wins`;
            if (m.outcome === "2") outcomeText = `${p2.name} Wins`;
            rows.push([p1.name, p1.archetype, p2.name, p2.archetype, outcomeText, m.roundNum]);
        }
    }
  });
  renderExamples(rows, a1, a2);
}

function renderExamples(rows, a1, a2) {
  examplesTable.innerHTML = "";
  const thead = examplesTable.createTHead();
  const caption = examplesTable.createCaption();
  caption.classList.add('caption-top', 'h4');
  caption.textContent = getTranslation('example_matches_caption', {a1: a1, a2: a2});
  
  const h = thead.insertRow();
  const headers = ['player_1_header', 'archetype_1_header', 'player_2_header', 'archetype_2_header', 'result_header', 'round_header'];
  headers.forEach(key => {
    h.insertCell().outerHTML = `<th>${getTranslation(key)}</th>`;
  });
  
  const tbody = examplesTable.createTBody();
  if (rows.length === 0) {
    const tr = tbody.insertRow();
    const td = tr.insertCell();
    td.colSpan = 6;
    td.textContent = getTranslation("no_examples_message");
    td.classList.add("text-center", "text-muted");
  } else {
    rows.forEach(r => {
        const tr = tbody.insertRow();
        r.forEach(val => tr.insertCell().textContent = String(val));
    });
  }
}

// ===== Initial Load =====
document.addEventListener('DOMContentLoaded', () => {
    const preferredLang = localStorage.getItem('preferred_language') || 'en';
    setLanguage(preferredLang);
});
</script>
</body>
</html>