<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>TDF Analyzer Web</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    background-color: #f8f9fa;
  }
  .archetype-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 8px;
    list-style: none;
    padding: 0;
  }
  .archetype-list li {
    position: relative;
    height: 90px;
    border-radius: 0.375rem;
    cursor: pointer;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    overflow: hidden;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    border: 1px solid #dee2e6;
  }
  .archetype-list li.selected {
    outline: 3px solid #0d6efd;
  }
  .archetype-list li .arch-name {
    width: 100%;
    text-align: center;
    font-weight: bold;
    color: #fff;
    padding: 6px 0;
    background: rgba(0,0,0,0.55);
  }
  .scroll {
    max-height: 500px;
    overflow: auto;
  }
  #playersContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 16px;
  }
  .player {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
  }
  .pill {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: .75em;
    font-weight: 700;
    line-height: 1;
    color: #212529;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
    background-color: #e9ecef;
  }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">TDF Analyzer Web</a>
    <span class="navbar-text">
      100% client-side. Tus datos no salen del navegador.
    </span>
  </div>
</nav>

<main class="container mt-4">
  <div class="row g-4">

    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2>1. Cargar archivos TDF/XML</h2>
        </div>
        <div class="card-body">
          <div class="row align-items-center g-3">
            <div class="col-md-5">
              <input type="file" id="xmlFiles" class="form-control" accept=".xml,.tdf" multiple>
            </div>
            <div class="col-md-5">
              <select id="tournamentSelect" class="form-select" title="Torneo"></select>
            </div>
            <div class="col-md-2">
              <span id="tdfSummary" class="form-text"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2>2. Editar arquetipos</h2>
        </div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
            <input type="text" id="archetypeName" class="form-control" style="width: 200px;" placeholder="Nombre de arquetipo">
            <input type="file" id="archetypeImage" class="form-control" style="width: 250px;" accept="image/*">
            <button id="addArchetype" class="btn btn-primary">Añadir</button>
            <button id="removeArchetype" class="btn btn-danger">Eliminar</button>
            <div class="btn-group">
                <button id="saveArchetypes" class="btn btn-secondary">Descargar JSON</button>
                <button id="loadArchetypes" class="btn btn-secondary">Importar JSON</button>
            </div>
            <div class="form-check form-switch ms-auto">
              <input class="form-check-input" type="checkbox" role="switch" id="persistArchetypes">
              <label class="form-check-label" for="persistArchetypes">Guardar en este navegador</label>
            </div>
          </div>
          <ul id="archetypeList" class="archetype-list"></ul>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2>3. Asignar arquetipos a jugadores</h2>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2 mb-3">
                <button id="saveAssignments" class="btn btn-secondary">Descargar asignaciones</button>
                <button id="loadAssignments" class="btn btn-secondary">Importar asignaciones</button>
                <div class="form-check form-switch ms-auto">
                    <input class="form-check-input" type="checkbox" role="switch" id="persistAssignments">
                    <label class="form-check-label" for="persistAssignments">Guardar en este navegador</label>
                </div>
            </div>
          <div id="playersContainer"></div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2>4. Filtros</h2>
        </div>
        <div class="card-body">
          <div class="row align-items-center g-3">
            <div class="col-md-3">
              <label for="divisionFilter" class="form-label">División:</label>
              <select id="divisionFilter" class="form-select">
                <option value="ALL">Todas</option>
                <option value="MR">MR</option>
                <option value="SR">SR</option>
                <option value="JR">JR</option>
              </select>
            </div>
            <div class="col-md-9">
              <button id="generateMatrix" class="btn btn-success mt-4">Generar matriz</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h2>5. Matriz de winrates</h2>
            </div>
            <div class="card-body">
                <div class="scroll table-responsive">
                    <table id="matrixTable" class="table table-bordered table-sm text-center"></table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h2>6. Ejemplos de partidas</h2>
            </div>
            <div class="card-body">
                <div class="scroll table-responsive">
                    <table id="examplesTable" class="table table-striped table-sm"></table>
                </div>
            </div>
        </div>
    </div>

  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ====== REFERENCIAS DOM ====== 
const xmlInput = document.getElementById("xmlFiles");
const tdfSummary = document.getElementById("tdfSummary");
const tournamentSelect = document.getElementById("tournamentSelect");
const listEl = document.getElementById("archetypeList");
const nameEl = document.getElementById("archetypeName");
const imgEl  = document.getElementById("archetypeImage");
const persistArchEl = document.getElementById("persistArchetypes");
const playersContainer = document.getElementById("playersContainer");
const persistAssignEl  = document.getElementById("persistAssignments");
const matrixTable = document.getElementById("matrixTable");
const divisionFilter = document.getElementById("divisionFilter");
const examplesTable = document.getElementById("examplesTable");

// ===== Utilidades y modelos =====
function getDivisionFromLastname(lastname) {
  if (lastname === "MR") return "MR";
  if (lastname === "SR") return "SR";
  if (lastname === "JR") return "JR";
  return "Unknown";
}
function lowestDivision(div1, div2) {
  const order = { MR:3, SR:2, JR:1 };
  return (order[div1] || 0) < (order[div2] || 0) ? div1 : div2;
}
function getWinrateColor(winrate) {
  // Gradiente de color Bootstrap-like
  if (winrate == null) return "#f8f9fa";  // Gris claro
  if (winrate < 0.45) return "#f8d7da";   // Rojo claro (bg-danger-subtle)
  if (winrate < 0.5) return "#fff3cd";    // Amarillo claro (bg-warning-subtle)
  if (winrate < 0.55) return "#cfe2ff";   // Azul claro (bg-primary-subtle)
  return "#d1e7dd"; // Verde claro (bg-success-subtle)
}

class Player {
  constructor(userid, name, division) {
    this.userid = userid;
    this.name = name;
    this.division = division;
    this.archetype = null;
  }
}
class Match {
  constructor(p1, p2, outcome, roundNum, podCat) {
    this.p1 = p1; this.p2 = p2;
    this.outcome = outcome;
    this.roundNum = roundNum;
    this.podCat = podCat;
  }
}
class TDFData {
  constructor(fileContent, name="") {
    this.fileContent = fileContent;
    this.name = name;
    this.players = {};
    this.matches = [];
  }
  parseFile() {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(this.fileContent, "application/xml");
    const playersNode = xmlDoc.querySelector("players");
    if (playersNode) {
      playersNode.querySelectorAll(":scope > player").forEach(p => {
        const userid = p.getAttribute("userid");
        const firstname = p.querySelector("firstname")?.textContent || "";
        const lastname = p.querySelector("lastname")?.textContent || "";
        const division = getDivisionFromLastname(lastname);
        this.players[userid] = new Player(userid, `${firstname} ${lastname}`, division);
      });
    }
    const podsNode = xmlDoc.querySelector("pods");
    if (podsNode) {
      podsNode.querySelectorAll(":scope > pod").forEach(pod => {
        const podCat = pod.getAttribute("category") || "";
        pod.querySelectorAll(":scope > rounds").forEach(rounds => {
          rounds.querySelectorAll(":scope > round").forEach(round => {
            const roundNum = round.getAttribute("number") || "";
            round.querySelectorAll(":scope > matches > match").forEach(match => {
              const p1 = match.querySelector(":scope > player1")?.getAttribute("userid");
              const p2 = match.querySelector(":scope > player2")?.getAttribute("userid");
              if (!p1 || !p2) return;
              const outcome = match.getAttribute("outcome") || "";
              this.matches.push(new Match(p1, p2, outcome, roundNum, podCat));
            });
          });
        });
      });
    }
  }
}

// ===== Estado global =====
let tdfDataList = []; // [{name, players, matches}]
let archetypes = [];  // [{name, imageDataUrl|null}]
let selectedArchIndex = null;
let playerArchetypeMap = {}; // {userid: archetypeName}

// ===== Helpers persistencia =====
function saveLocal(key, value, enabled) {
  if (!enabled) return;
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {
    console.error("Error saving to local storage", e);
  }
}
function loadLocal(key) {
  const raw = localStorage.getItem(key);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

// ===== Carga de archivos =====
xmlInput.addEventListener("change", (evt) => {
  const files = Array.from(evt.target.files);
  tdfDataList = [];
  tournamentSelect.innerHTML = '<option value="">Seleccione un torneo</option>';
  playerArchetypeMap = {};
  if (files.length === 0) {
    tdfSummary.textContent = "";
    renderPlayers();
    renderMatrix();
    renderExamples([]);
    return;
  }
  let pending = files.length;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const tdf = new TDFData(e.target.result, file.name);
      tdf.parseFile();
      tdfDataList.push(tdf);
      if (--pending === 0) {
        tdfDataList.forEach((tdf, i) => {
          const opt = document.createElement("option");
          opt.value = String(i);
          opt.textContent = `${i+1}. ${tdf.name || 'Torneo'}`;
          tournamentSelect.appendChild(opt);
        });
        tdfSummary.textContent = `Cargados ${tdfDataList.length} torneos.`;
        if(tdfDataList.length > 0) tournamentSelect.value = "0";
        renderPlayers();
        renderMatrix(); 
      }
    };
    reader.readAsText(file);
  });
});

// ===== Arquetipos (CRUD) =====
(function bootstrapArchetypes() {
  persistArchEl.checked = !!loadLocal("tdf_persist_arch");
  persistArchEl.addEventListener("change", () => saveLocal("tdf_persist_arch", persistArchEl.checked, true));
  
  const saved = persistArchEl.checked ? loadLocal("tdf_archetypes") : null;
  if (saved && saved.length > 0) {
    archetypes = saved;
    refreshArchetypeList();
  } else {
    fetch('archetypes.json')
      .then(res => res.ok ? res.json() : Promise.reject())
      .then(data => {
        archetypes = (Array.isArray(data) && typeof data[0] === "string")
          ? data.map(n => ({name:n, image:null}))
          : data;
        refreshArchetypeList();
      })
      .catch(() => { /* No-op */ });
  }
})();

function refreshArchetypeList() {
  listEl.innerHTML = "";
  archetypes.sort((a, b) => a.name.localeCompare(b.name));
  archetypes.forEach((arch, idx) => {
    const li = document.createElement("li");
    li.dataset.index = String(idx);
    if (Number(idx) === selectedArchIndex) li.classList.add("selected");
    
    let imagePath = arch.image;
    // Heuristic to check if it's a local server path vs a data URL
    if (imagePath && !imagePath.startsWith('data:image')) {
        // Assuming a flat structure for archetype_images
        const imageName = imagePath.split(/[\\/]/).pop();
        imagePath = `archetype_images/${imageName}`;
    }
    
    li.style.backgroundImage = imagePath ? `url('${imagePath.replace(/\\/g, "/")}')` : 'none';
    li.style.backgroundColor = imagePath ? '#6c757d' : '#e9ecef';

    const nameSpan = document.createElement("span");
    nameSpan.className = "arch-name";
    nameSpan.textContent = arch.name;
    li.appendChild(nameSpan);

    li.addEventListener("click", () => {
      selectedArchIndex = (selectedArchIndex === idx) ? null : idx; // Toggle selection
      refreshArchetypeList();
    });
    listEl.appendChild(li);
  });
  renderPlayers(); // Re-render players to update dropdowns if archetypes change
}

document.getElementById("addArchetype").addEventListener("click", () => {
  const name = nameEl.value.trim();
  if (!name || archetypes.some(a => a.name === name)) {
    alert("El nombre del arquetipo no puede estar vacío o duplicado.");
    return;
  }
  if (imgEl.files.length > 0) {
    const reader = new FileReader();
    reader.onload = e => {
      archetypes.push({ name, image: e.target.result });
      nameEl.value = ""; imgEl.value = "";
      saveLocal("tdf_archetypes", archetypes, persistArchEl.checked);
      refreshArchetypeList();
    };
    reader.readAsDataURL(imgEl.files[0]);
  } else {
    archetypes.push({ name, image: null });
    nameEl.value = ""; imgEl.value = "";
    saveLocal("tdf_archetypes", archetypes, persistArchEl.checked);
    refreshArchetypeList();
  }
});

document.getElementById("removeArchetype").addEventListener("click", () => {
  if (selectedArchIndex == null) return;
  const removed = archetypes.splice(selectedArchIndex, 1)[0];
  Object.keys(playerArchetypeMap).forEach(uid => {
    if (playerArchetypeMap[uid] === removed.name) delete playerArchetypeMap[uid];
  });
  selectedArchIndex = null;
  saveLocal("tdf_archetypes", archetypes, persistArchEl.checked);
  saveLocal("tdf_assignments", playerArchetypeMap, persistAssignEl.checked);
  refreshArchetypeList();
});

document.getElementById("saveArchetypes").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(archetypes, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement("a"), { href:url, download:"archetypes.json" });
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

document.getElementById("loadArchetypes").addEventListener("click", () => {
  const input = Object.assign(document.createElement("input"), { type: "file", accept: ".json" });
  input.onchange = () => {
    const file = input.files[0]; if (!file) return;
    const r = new FileReader();
    r.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        archetypes = (Array.isArray(data) && typeof data[0] === "string")
          ? data.map(n => ({name:n, image:null}))
          : data;
        saveLocal("tdf_archetypes", archetypes, persistArchEl.checked);
        refreshArchetypeList();
      } catch { alert("JSON inválido"); }
    };
    r.readAsText(file);
  };
  input.click();
});

// ===== Asignación de arquetipos a jugadores =====
(function bootstrapAssignments() {
  persistAssignEl.checked = !!loadLocal("tdf_persist_assign");
  persistAssignEl.addEventListener("change", () => saveLocal("tdf_persist_assign", persistAssignEl.checked, true));

  const saved = persistAssignEl.checked ? loadLocal("tdf_assignments") : null;
  if (saved) playerArchetypeMap = saved;
})();

function allPlayersCurrentTournament() {
  const idx = Number(tournamentSelect.value);
  if (isNaN(idx) || idx < 0 || idx >= tdfDataList.length) return {};
  const tdf = tdfDataList[idx];
  return tdf ? tdf.players : {};
}

function renderPlayers() {
  playersContainer.innerHTML = "";
  const players = allPlayersCurrentTournament();
  const archNames = archetypes.map(a => a.name);
  // Sort players by name
  const sortedPlayers = Object.values(players).sort((a,b) => a.name.localeCompare(b.name));

  sortedPlayers.forEach(p => {
    const row = document.createElement("div");
    row.className = "player";
    
    const info = document.createElement("div");
    info.innerHTML = `<strong>${p.name}</strong> <span class="pill">${p.division}</span> <small class="text-muted ms-2">ID: ${p.userid}</small>`;
    
    const select = document.createElement("select");
    select.className = "form-select form-select-sm";
    select.style.width = "180px";
    select.dataset.userid = p.userid;
    select.innerHTML = '<option value="">(sin asignar)</option>'; // Empty option first
    
    archNames.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name; opt.textContent = name;
      select.appendChild(opt);
    });

    if (playerArchetypeMap[p.userid]) select.value = playerArchetypeMap[p.userid];
    
    select.addEventListener("change", () => {
      if (select.value) playerArchetypeMap[p.userid] = select.value;
      else delete playerArchetypeMap[p.userid];
      saveLocal("tdf_assignments", playerArchetypeMap, persistAssignEl.checked);
    });
    
    row.appendChild(info);
    row.appendChild(select);
    playersContainer.appendChild(row);
  });
}

document.getElementById("saveAssignments").addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(playerArchetypeMap, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement("a"), { href:url, download:"player_archetypes.json" });
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

document.getElementById("loadAssignments").addEventListener("click", () => {
  const input = Object.assign(document.createElement("input"), { type: "file", accept: ".json" });
  input.onchange = () => {
    const file = input.files[0]; if (!file) return;
    const r = new FileReader();
    r.onload = e => {
      try {
        playerArchetypeMap = JSON.parse(e.target.result);
        saveLocal("tdf_assignments", playerArchetypeMap, persistAssignEl.checked);
        renderPlayers();
      } catch { alert("JSON inválido"); }
    };
    r.readAsText(file);
  };
  input.click();
});

tournamentSelect.addEventListener("change", () => {
  renderPlayers();
  renderMatrix();
  renderExamples([]);
});

// ===== Matriz de winrates =====
document.getElementById("generateMatrix").addEventListener("click", renderMatrix);
divisionFilter.addEventListener("change", renderMatrix);


function computeMatrixData(tdf) {
  const stats = new Map();
  const withMatches = new Set();

  function keyFor(a, b) { return a <= b ? `${a}|||${b}` : `${b}|||${a}`; }
  function getEntry(a,b) {
    const k = keyFor(a,b);
    if (!stats.has(k)) {
      stats.set(k, { a: k.split("|||")[0], b: k.split("|||")[1],
        winsA:0, winsB:0, ties:0, mirrors:0, samples:[] });
    }
    return stats.get(k);
  }

  const divFilter = divisionFilter.value;
  Object.entries(tdf.players).forEach(([uid, p]) => {
    p.archetype = playerArchetypeMap[uid] || null;
  });

  tdf.matches.forEach(m => {
    const p1 = tdf.players[m.p1], p2 = tdf.players[m.p2];
    if (!p1 || !p2 || !p1.archetype || !p2.archetype) return;

    const matchDiv = lowestDivision(p1.division, p2.division);
    if (divFilter !== "ALL" && matchDiv !== divFilter) return;

    withMatches.add(p1.archetype); withMatches.add(p2.archetype);

    if (p1.archetype === p2.archetype) {
      const e = getEntry(p1.archetype, p2.archetype);
      e.mirrors++;
    } else {
      const e = getEntry(p1.archetype, p2.archetype);
      if (m.outcome === "1") e.a === p1.archetype ? e.winsA++ : e.winsB++;
      else if (m.outcome === "2") e.b === p1.archetype ? e.winsA++ : e.winsB++;
      else if (m.outcome === "3") e.ties++;
    }
  });
  
  const archs = Array.from(withMatches).sort();
  return { stats, archs };
}

function renderMatrix() {
  matrixTable.innerHTML = "";
  const idx = Number(tournamentSelect.value);
  if (isNaN(idx) || idx < 0 || idx >= tdfDataList.length) {
      matrixTable.innerHTML = "<thead><tr><th class='text-muted fw-normal'>Selecciona un torneo para ver la matriz.</th></tr></thead>";
      return;
  }
  const tdf = tdfDataList[idx];

  const { stats, archs } = computeMatrixData(tdf);
  if (archs.length === 0) {
    matrixTable.innerHTML = "<thead><tr><th class='text-muted fw-normal'>No hay datos suficientes (asigna arquetipos y aplica filtros).</th></tr></thead>";
    renderExamples([]);
    return;
  }

  const thead = matrixTable.createTHead();
  const hrow = thead.insertRow();
  hrow.insertCell().outerHTML = "<th></th>";
  archs.forEach(a => hrow.insertCell().outerHTML = `<th class="text-truncate" style="max-width: 150px;">${a}</th>`);

  const tbody = matrixTable.createTBody();

  function getEntry(a,b) {
    const k = a <= b ? `${a}|||${b}` : `${b}|||${a}`;
    return stats.get(k);
  }

  archs.forEach(a1 => {
    const row = tbody.insertRow();
    row.insertCell().outerHTML = `<th class="text-truncate" style="max-width: 150px;">${a1}</th>`;

    archs.forEach(a2 => {
      const td = row.insertCell();
      td.style.cursor = "pointer";
      td.dataset.arch1 = a1;
      td.dataset.arch2 = a2;

      if (a1 === a2) {
        const e = getEntry(a1, a2);
        td.textContent = e ? `${e.mirrors}m` : '0m';
        td.style.backgroundColor = "#e9ecef";
        td.title = `${e ? e.mirrors : 0} mirrors`;
      } else {
        const e = getEntry(a1, a2);
        if (!e) { 
          td.textContent = "0-0-0";
          td.style.backgroundColor = "#f8f9fa";
          td.title = "0 wins, 0 losses, 0 ties";
        } else {
            const wins = e.a === a1 ? e.winsA : e.winsB;
            const losses = e.a === a1 ? e.winsB : e.winsA;
            const ties = e.ties;
            const total = wins + losses;
            const winrate = total > 0 ? (wins / total) : null;
            
            td.innerHTML = `<div class="fw-bold">${(winrate != null ? (winrate * 100).toFixed(0) : "–")}%</div>
                            <small class="text-muted">${wins}-${losses}-${ties}</small>`;
            td.style.backgroundColor = getWinrateColor(winrate);
            td.title = `${wins} wins, ${losses} losses, ${ties} ties`;
        }
      }

      td.addEventListener("click", () => showExamplesForCell(a1, a2));
    });
  });
}

// ===== Ejemplos =====
function showExamplesForCell(a1, a2) {
  const idx = Number(tournamentSelect.value);
  if (isNaN(idx) || idx < 0 || idx >= tdfDataList.length) return;
  const tdf = tdfDataList[idx];

  Object.entries(tdf.players).forEach(([uid, p]) => {
    p.archetype = playerArchetypeMap[uid] || null;
  });
  const divFilter = divisionFilter.value;

  const rows = [];
  tdf.matches.forEach(m => {
    const p1 = tdf.players[m.p1], p2 = tdf.players[m.p2];
    if (!p1 || !p2 || !p1.archetype || !p2.archetype) return;
    const matchDiv = lowestDivision(p1.division, p2.division);
    if (divFilter !== "ALL" && matchDiv !== divFilter) return;

    if (a1 === a2) {
        if (p1.archetype === a1 && p2.archetype === a2) {
            let result = "Tie";
            if (m.outcome === "1") result = "P1 Win";
            if (m.outcome === "2") result = "P2 Win";
            rows.push([p1.name, p1.archetype, p2.name, p2.archetype, result, m.roundNum]);
        }
    } else {
        const p1isA1 = p1.archetype === a1;
        const p2isA2 = p2.archetype === a2;
        const p1isA2 = p1.archetype === a2;
        const p2isA1 = p2.archetype === a1;

        if ((p1isA1 && p2isA2) || (p1isA2 && p2isA1)) {
            let outcomeText = "Tie";
            if (m.outcome === "1") outcomeText = `${p1.name} Wins`;
            if (m.outcome === "2") outcomeText = `${p2.name} Wins`;
            rows.push([p1.name, p1.archetype, p2.name, p2.archetype, outcomeText, m.roundNum]);
        }
    }
  });
  renderExamples(rows, a1, a2);
}

function renderExamples(rows, a1, a2) {
  examplesTable.innerHTML = "";
  const thead = examplesTable.createTHead();
  const caption = examplesTable.createCaption();
  caption.classList.add('caption-top', 'h4');
  caption.textContent = `Partidas de ejemplo: ${a1} vs ${a2}`;
  
  const h = thead.insertRow();
  ["Player 1","Archetype 1","Player 2","Archetype 2","Result","Round"].forEach(t => {
    h.insertCell().outerHTML = `<th>${t}</th>`;
  });
  
  const tbody = examplesTable.createTBody();
  if (rows.length === 0) {
    const tr = tbody.insertRow();
    const td = tr.insertCell();
    td.colSpan = 6;
    td.textContent = "No hay ejemplos para esta combinación de filtros.";
    td.classList.add("text-center", "text-muted");
  } else {
    rows.forEach(r => {
        const tr = tbody.insertRow();
        r.forEach(val => tr.insertCell().textContent = String(val));
    });
  }
}

// ===== Initial Render =====
renderPlayers();
renderMatrix();
renderExamples("", "");
</script>
</body>
</html>